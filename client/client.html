<!DOCTYPE html>
<html lang="en">
<head>
	<style>
		body
		{
			background-color: lightgrey;
		}
		
		canvas
		{
			background-color: white;
		}
	</style>
    <script src="/socket.io/socket.io.js"></script>
    <script>
        "use strict";
    
        var canvas;
        var ctx;
        var socket;
		var squares = {};
		var points = 0;
		var flag = {};
		var animationID;
		var wIsPressed = false;
		var aIsPressed = false;
		var sIsPressed = false;
		var dIsPressed = false;

        var square = {
            id: new Date().getTime(),
			time: new Date().getTime(),
            x: Math.random()*400,
            y: Math.random()*400,
            height: 20,
            width: 20,
			color: "rgba("+Math.floor(Math.random()*255)+", "+Math.floor(Math.random()*255)+", "+Math.floor(Math.random()*255)+", 1)",
			points: 0
        };
		
		function redraw()
		{
			ctx.clearRect(0,0,canvas.width, canvas.height);
			var key = Object.keys(squares);
			
			ctx.fillStyle = flag.color;
			ctx.beginPath();
			ctx.arc(flag.x, flag.y, flag.radius, 0, 2*Math.PI);
			ctx.fill();
			ctx.closePath();
			
			for(var i = 0;i<key.length;i++)
			{
				ctx.fillStyle = squares[key[i]].color;
				ctx.fillRect(squares[key[i]].x, squares[key[i]].y, squares[key[i]].width, squares[key[i]].height);
				if(squares[key[i]].id == square.id)
				{
					ctx.fillStyle = "black";
					ctx.fillText("Score: " + squares[key[i]].points, 10, 20);
					square.points = squares[key[i]].points;
				}
			}
		}
		
		function update()
		{
			animationID = requestAnimationFrame(update);
			if(wIsPressed)
			{
				square.y -= 1;
			}
			
			if(aIsPressed)
			{
				square.x -= 1;
			}
			
			if(sIsPressed)
			{
				square.y += 1;
			}
			
			if(dIsPressed)
			{
				square.x += 1;
			}
			
			if(wIsPressed || aIsPressed || sIsPressed || dIsPressed)
			{
				sendPos();
			}
		}
		
		function sendPos()
		{
			var message = 
			{
				message: "",
				id: square.id,
				data: square,
				time: new Date().getTime()
			};
			
			socket.emit("updatePos", message);
		}
        
        function init() 
		{
            canvas = document.querySelector("#canvas");
            ctx = canvas.getContext("2d");
			
			ctx.font = "20px Arial";
			
			socket = io.connect();
			socket.on("connect", function()
			{
				var message = 
				{
					message: "",
					id: square.id,
					data: square
				};
				socket.emit("init", message);
			});
			
			socket.on("allSquares", function(data)
			{
				squares = data.data;
				flag = data.flag;
				console.log("flag set "+data.flag);
				redraw();
			});
			
			socket.on("updatePoints", function(data)
			{
				console.log("points " + data.data);
				if(data.data[square.id].points > square.points)
				{
					squares = data.data;
				}
				flag = data.flag;
			});
			
			document.onkeydown = function(e)
			{
				var charCode = String.fromCharCode(e.keyCode);
				if(charCode == "W")
				{
					wIsPressed = true;
				}
				
				if(charCode == "A")
				{
					aIsPressed = true;
				}
				
				if(charCode == "S")
				{
					sIsPressed = true;
				}
				
				if(charCode == "D")
				{
					dIsPressed = true;
				}
			};
			
			document.onkeyup = function(e)
			{
				var charCode = String.fromCharCode(e.keyCode);
				if(charCode == "W")
				{
					wIsPressed = false;
				}
				
				if(charCode == "A")
				{
					aIsPressed = false;
				}
				
				if(charCode == "S")
				{
					sIsPressed = false;
				}
				
				if(charCode == "D")
				{
					dIsPressed = false;
				}
			};
			
			requestAnimationFrame(update);
        }

    window.onload = init;
	window.onbeforeunload = function()
	{
		var message = 
		{
			message: "",
			id: square.id,
			data: ""
		};
		socket.emit("leaving", message);
	};
    </script>
</head>
<body>
    <canvas id="canvas" height="500" width="500">Please use an HTML 5 browser</canvas>
</body>
</html>